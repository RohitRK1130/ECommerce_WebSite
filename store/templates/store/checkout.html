{% extends 'store/base_sub_page.html' %}

{% load static %}
{% block subcontent %}

<div class="hero_area">
    <!-- header section strats -->
    <header class="header_section">
    <div class="container">
        {% include "store/navbar.html" %} 
    </div>
    </header>
    <!-- end header section -->

    <div class="container" id="checkout-container">
        <div class="card" id="checkout-card">
        <div class="row">
            <div class="col-75">
                <div class="container" id="checkoutdetails-container">
                    <form id="form">
                        <div class="row">
                            <div class="col-50">
                            <h3>Billing Details</h3>
                            <input type="hidden" name="total" value="{{order.get_cart_total|floatformat:2}}">
                            <div id="user-info">
                                <label for="fname"><i class="fa fa-user"></i> Full Name</label>
                                <input type="text" id="fname" name="firstname" placeholder="John M. Doe">
                                <label for="email"><i class="fa fa-envelope"></i> Email</label>
                                <input type="text" id="email" name="email" placeholder="john@example.com">
                            </div>
                            <div id="user-address">
                                <label for="adr"><i class="fa fa-address-card-o"></i> Address</label>
                                <input type="text" id="adr" name="address" placeholder="542 W. 15th Street">
                                <label for="city"><i class="fa fa-institution"></i> City</label>
                                <input type="text" id="city" name="city" placeholder="New York">
                                
                                <div class="row">
                                    <div class="col-50">
                                    <label for="state">State</label>
                                    <input type="text" id="state" name="state" placeholder="NY">
                                    </div>
                                    <div class="col-50">
                                    <label for="zip">Zip</label>
                                    <input type="text" id="zip" name="zip" placeholder="10001">
                                    </div>
                                </div>
                                <!-- <label>
                                    <input type="checkbox" checked="checked" name="sameadr"> Shipping address same as billing
                                </label> -->
                            </div>
                            </div>
                        </div>
                        <input type="submit" id="form-submit" value="Continue to checkout" class="btn">
                    </form>
                    <div class="hidden" id="payment-info">
                        <div class="row">
                            <div class="col-50">
                                <h3>Payment Gateway</h3>
                                <button id="rzp-button1" class="btn">Make Payment - Razorpay</button>
                            </div>
                        </div>
                    </div>
                </div>

                </div>
                <div class="col-25">
                <div class="container" id="checkoutdetails-container">
                    <h4>Cart
                    <span class="price" style="color:black">
                        <i class="fa fa-shopping-cart"></i>
                        <b>{{order.get_cart_items}}</b>
                    </span>
                    </h4>
                    <hr>
                    {% for item in items %}
                    <p><a href="#">{{item.product.name}}</a> <span class="price">₹{{item.get_total|floatformat:2}}</span></p>
                    {% endfor %}
                    <hr>
                    <p>Total <span class="price" style="color:black"><b>₹{{order.get_cart_total|floatformat:2}}</b></span></p>
                </div>
                </div>
            </div>
        </div>
    </div>

    <script src = "https://checkout.razorpay.com/v1/checkout.js"></script>
    
    <script>
        var shipping = '{{order.shipping}}'
        if (shipping == 'False') {
            document.getElementById("user-address").innerHTML = ''
        }

        if (user != 'AnonymousUser') {
            document.getElementById("user-info").innerHTML = ''
        }

        if (shipping == 'False' && user != 'AnonymousUser') {
            document.getElementById('form-submit').classList.add('hidden')
            document.getElementById('payment-info').classList.remove('hidden')
        }

        var form = document.getElementById('form')

        form.addEventListener('submit', function(e){
            e.preventDefault()
            document.getElementById('form').classList.add('hidden')
            document.getElementById('form-submit').classList.add('hidden')
            document.getElementById('payment-info').classList.remove('hidden')
        })

        var makepayment = document.getElementById('form-submit')
        
        makepayment.addEventListener('click', function(e) {
            submitFormData()
        })

        var total = '{{order.get_cart_total|floatformat:2}}'

        function submitFormData(params) {
            console.log("Payment Done")
            var userFormData = {
                'fname': null,
                'email': null,
                'total': total,
            }

            var shippingInfo = {
                'address': null,
                'city': null,
                'state': null,
                'zip': null,
            }

            if (shipping != 'False') {
                shippingInfo.address = form.address.value
                shippingInfo.city = form.city.value
                shippingInfo.state = form.state.value
                shippingInfo.zip = form.zip.value
            }

            if (user == 'AnonymousUser') {
                userFormData.fname = form.fname.value
                userFormData.email = form.email.value
            }

            // Make an AJAX request to your Django view
            $.ajax({
                url: "/process_order/",
                method: "POST",
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                data: JSON.stringify({'form':userFormData, 'shipping':shippingInfo}),
                success: function (response) {
                    
                    if (response['status'] == "success") {

                        var options = {
                                "key": "rzp_test_q03yAzvCR5hPJp",
                                "amount": response['amount'],
                                "currency": "INR",
                                "order_id": response['id'],
                                "name": "EComm",
                                "description": "Purchases",
                                "image": "http://127.0.0.1:8000/static/images/logo.png",
                                "handler": function(response) {
                                    window.location.href = `/razorpay-success/?razorpay_order_id=${response.razorpay_order_id}`
                                },
                                "theme": {
                                "color": "#F37254"
                                }
                            };
                    
                        var rzp1 = new Razorpay(options);
                        document.getElementById('rzp-button1').onclick = function(e) {
                        rzp1.open();
                        e.preventDefault();
                        }

                    } else {
                        alert("Something went wrong. Please try again after some time...")
                        window.location.href = "/"
                    }

                },
            });
        }
    </script>
{% endblock subcontent %}
